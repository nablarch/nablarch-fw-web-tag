package nablarch.common.web.tag;

import java.util.Locale;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.jsp.tagext.Tag;

import nablarch.common.web.handler.WebTestUtil;
import nablarch.core.ThreadContext;
import nablarch.core.util.Builder;
import nablarch.fw.web.i18n.ResourcePathRule;

import org.junit.Before;
import org.junit.Test;

import static org.hamcrest.core.Is.is;
import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertThat;
import static org.junit.Assert.assertTrue;

/**
 * @author Kiyohito Itoh
 */
public class ImgTagTest extends TagTestSupport<ImgTag> {

    public ImgTagTest() {
        super(new ImgTag());
    }

    @Before
    public void setup() {
        TagTestUtil.setUpDefaultConfig();
    }

    @Test
    public void testInputPageForAllSetting() throws Exception {
        
        FormContext formContext = TagTestUtil.createFormContext();
        TagUtil.setFormContext(pageContext, formContext);
        
        // generic
        TagTestUtil.setGenericAttributes(target);
        
        // img
        target.setSrc("./R12345?a=b");
        target.setAlt("alt_test");
        target.setName("name_test");
        target.setLongdesc("longdesc_test");
        target.setHeight("height_test");
        target.setWidth("width_test");
        target.setUsemap("usemap_test");
        target.setIsmap("ismap_test");
        target.setAlign("align_test");
        target.setBorder("border_test");
        target.setHspace("hspace_test");
        target.setVspace("vspace_test");
        
        assertThat(target.doStartTag(), is(Tag.SKIP_BODY));
        assertThat(target.doEndTag(), is(Tag.EVAL_PAGE));
        
        String actual = TagTestUtil.getOutput(pageContext);
        String expected = Builder.lines(
                "<img",
                "id=\"id_test\"",
                "class=\"css_test\"",
                "style=\"style_test\"",
                "title=\"title_test\"",
                "lang=\"lang_test\"",
                "xml:lang=\"xmlLang_test\"",
                "dir=\"dir_test\"",
                "name=\"name_test\"",
                "src=\"./R12345?a=b" + WebTestUtil.ENCODE_URL_SUFFIX + "&nablarch_static_content_version=1.0.0" + '"',
                "alt=\"alt_test\"",
                "usemap=\"usemap_test\"",
                "align=\"align_test\"",
                "longdesc=\"longdesc_test\"",
                "height=\"height_test\"",
                "width=\"width_test\"",
                "ismap=\"ismap_test\"",
                "border=\"border_test\"",
                "hspace=\"hspace_test\"",
                "vspace=\"vspace_test\"",
                "onclick=\"onclick_test\"",
                "ondblclick=\"ondblclick_test\"",
                "onmousedown=\"onmousedown_test\"",
                "onmouseup=\"onmouseup_test\"",
                "onmouseover=\"onmouseover_test\"",
                "onmousemove=\"onmousemove_test\"",
                "onmouseout=\"onmouseout_test\"",
                "onkeypress=\"onkeypress_test\"",
                "onkeydown=\"onkeydown_test\"",
                "onkeyup=\"onkeyup_test\" />").replace(Builder.LS, " ");
        System.out.println(actual);
        TagTestUtil.assertTag(actual, expected, " ");
        
        assertFalse(formContext.getInputNames().contains("name_test"));
    }

    @Test
    public void testInputPageForAllSettingWithHtml() throws Exception {
        
        FormContext formContext = TagTestUtil.createFormContext();
        TagUtil.setFormContext(pageContext, formContext);
        
        // generic
        TagTestUtil.setGenericAttributesWithHtml(target);
        
        // img
        target.setSrc("./R12345" + TagTestUtil.HTML);
        target.setAlt("alt_test" + TagTestUtil.HTML);
        target.setName("name_test" + TagTestUtil.HTML);
        target.setLongdesc("longdesc_test" + TagTestUtil.HTML);
        target.setHeight("height_test" + TagTestUtil.HTML);
        target.setWidth("width_test" + TagTestUtil.HTML);
        target.setUsemap("usemap_test" + TagTestUtil.HTML);
        target.setIsmap("ismap_test" + TagTestUtil.HTML);
        target.setAlign("align_test" + TagTestUtil.HTML);
        target.setBorder("border_test" + TagTestUtil.HTML);
        target.setHspace("hspace_test" + TagTestUtil.HTML);
        target.setVspace("vspace_test" + TagTestUtil.HTML);
        
        assertThat(target.doStartTag(), is(Tag.SKIP_BODY));
        assertThat(target.doEndTag(), is(Tag.EVAL_PAGE));
        
        String actual = TagTestUtil.getOutput(pageContext);
        String expected = Builder.lines(
                "<img",
                "id=\"id_test" + TagTestUtil.ESC_HTML + "\"",
                "class=\"css_test" + TagTestUtil.ESC_HTML + "\"",
                "style=\"style_test" + TagTestUtil.ESC_HTML + "\"",
                "title=\"title_test" + TagTestUtil.ESC_HTML + "\"",
                "lang=\"lang_test" + TagTestUtil.ESC_HTML + "\"",
                "xml:lang=\"xmlLang_test" + TagTestUtil.ESC_HTML + "\"",
                "dir=\"dir_test" + TagTestUtil.ESC_HTML + "\"",
                "name=\"name_test" + TagTestUtil.ESC_HTML + "\"",
                "src=\"./R12345" + TagTestUtil.ESC_HTML + WebTestUtil.ENCODE_URL_SUFFIX + "?nablarch_static_content_version=1.0.0" + '"',
                "alt=\"alt_test" + TagTestUtil.ESC_HTML + "\"",
                "usemap=\"usemap_test" + TagTestUtil.ESC_HTML + "\"",
                "align=\"align_test" + TagTestUtil.ESC_HTML + "\"",
                "longdesc=\"longdesc_test" + TagTestUtil.ESC_HTML + "\"",
                "height=\"height_test" + TagTestUtil.ESC_HTML + "\"",
                "width=\"width_test" + TagTestUtil.ESC_HTML + "\"",
                "ismap=\"ismap_test" + TagTestUtil.ESC_HTML + "\"",
                "border=\"border_test" + TagTestUtil.ESC_HTML + "\"",
                "hspace=\"hspace_test" + TagTestUtil.ESC_HTML + "\"",
                "vspace=\"vspace_test" + TagTestUtil.ESC_HTML + "\"",
                "onclick=\"onclick_test" + TagTestUtil.ESC_HTML + "\"",
                "ondblclick=\"ondblclick_test" + TagTestUtil.ESC_HTML + "\"",
                "onmousedown=\"onmousedown_test" + TagTestUtil.ESC_HTML + "\"",
                "onmouseup=\"onmouseup_test" + TagTestUtil.ESC_HTML + "\"",
                "onmouseover=\"onmouseover_test" + TagTestUtil.ESC_HTML + "\"",
                "onmousemove=\"onmousemove_test" + TagTestUtil.ESC_HTML + "\"",
                "onmouseout=\"onmouseout_test" + TagTestUtil.ESC_HTML + "\"",
                "onkeypress=\"onkeypress_test" + TagTestUtil.ESC_HTML + "\"",
                "onkeydown=\"onkeydown_test" + TagTestUtil.ESC_HTML + "\"",
                "onkeyup=\"onkeyup_test" + TagTestUtil.ESC_HTML + "\" />").replace(Builder.LS, " ");
        System.out.println(actual);
        TagTestUtil.assertTag(actual, expected, " ");
        
        assertFalse(formContext.getInputNames().contains("name_test"));
    }

    @Test
    public void testInputPageForDefault() throws Exception {
        
        FormContext formContext = TagTestUtil.createFormContext();
        TagUtil.setFormContext(pageContext, formContext);
        
        // img
        target.setSrc("./R12345");
        target.setAlt("alt_test");
        
        assertThat(target.doStartTag(), is(Tag.SKIP_BODY));
        assertThat(target.doEndTag(), is(Tag.EVAL_PAGE));
        
        String actual = TagTestUtil.getOutput(pageContext);
        String expected = Builder.lines(
                "<img",
                "src=\"./R12345" + WebTestUtil.ENCODE_URL_SUFFIX + "?nablarch_static_content_version=1.0.0" + '"',
                "alt=\"alt_test\" />").replace(Builder.LS, " ");
        System.out.println(actual);
        TagTestUtil.assertTag(actual, expected, " ");
        
        assertFalse(formContext.getInputNames().contains("name_test"));
    }

    /**
     * „Çµ„É≠„Ç≤„Éº„Éà„Éö„Ç¢„ÇíÊâ±„ÅÜ„ÉÜ„Çπ„Éà„Ç±„Éº„Çπ„ÄÇ
     * @throws Exception
     */
    @Test
    public void testInputPageForSurrogatepair() throws Exception {

        FormContext formContext = TagTestUtil.createFormContext();
        TagUtil.setFormContext(pageContext, formContext);

        // img
        target.setSrc("./R12345");
        target.setAlt("üôäüôäüôä_test");

        assertThat(target.doStartTag(), is(Tag.SKIP_BODY));
        assertThat(target.doEndTag(), is(Tag.EVAL_PAGE));

        String actual = TagTestUtil.getOutput(pageContext);
        String expected = Builder.lines(
                "<img",
                "src=\"./R12345" + WebTestUtil.ENCODE_URL_SUFFIX + "?nablarch_static_content_version=1.0.0" + '"',
                "alt=\"üôäüôäüôä_test\" />").replace(Builder.LS, " ");
        System.out.println(actual);
        TagTestUtil.assertTag(actual, expected, " ");

        assertFalse(formContext.getInputNames().contains("name_test"));
    }

    @Test
    public void testInputPageForSecure() throws Exception {
        
        TagTestUtil.setUpDefaultConfig();

        FormContext formContext = TagTestUtil.createFormContext();
        TagUtil.setFormContext(pageContext, formContext);
        
        // img
        target.setAlt("alt_test");
        
        // secureÂ±ûÊÄß„Ååtrue„ÅÆÂ†¥Âêà
        
        target.setSrc("/R12345");
        target.setSecure(true);
        
        assertThat(target.doStartTag(), is(Tag.SKIP_BODY));
        assertThat(target.doEndTag(), is(Tag.EVAL_PAGE));
        
        String actual = TagTestUtil.getOutput(pageContext);
        String expected = Builder.lines(
                "<img",
                "src=\"https://nablarch.co.jp:443" + WebTestUtil.CONTEXT_PATH + "/R12345" + WebTestUtil.ENCODE_URL_SUFFIX + "?nablarch_static_content_version=1.0.0" + '"',
                "alt=\"alt_test\" />").replace(Builder.LS, " ");
        System.out.println(actual);
        TagTestUtil.assertTag(actual, expected, " ");
        
        assertFalse(formContext.getInputNames().contains("name_test"));
        
        // secureÂ±ûÊÄß„Ååfalse„ÅÆÂ†¥Âêà

        TagTestUtil.clearOutput(pageContext);
        formContext = TagTestUtil.createFormContext();
        TagUtil.setFormContext(pageContext, formContext);
        
        target.setSrc("/R12345");
        target.setSecure(false);
        
        assertThat(target.doStartTag(), is(Tag.SKIP_BODY));
        assertThat(target.doEndTag(), is(Tag.EVAL_PAGE));
        
        actual = TagTestUtil.getOutput(pageContext);
        expected = Builder.lines(
                "<img",
                "src=\"http://nablarch.co.jp:8080" + WebTestUtil.CONTEXT_PATH + "/R12345" + WebTestUtil.ENCODE_URL_SUFFIX + "?nablarch_static_content_version=1.0.0" + '"',
                "alt=\"alt_test\" />").replace(Builder.LS, " ");
        System.out.println(actual);
        TagTestUtil.assertTag(actual, expected, " ");
        
        assertFalse(formContext.getInputNames().contains("name_test"));
        
        // secureÂ±ûÊÄß„Ååtrue„ÅÆÂ†¥Âêà„ÄÅ„Åã„Å§securePort„ÅÆÊåáÂÆö„Åå„Å™„ÅÑÂ†¥Âêà

        TagTestUtil.clearOutput(pageContext);
        formContext = TagTestUtil.createFormContext();
        TagUtil.setFormContext(pageContext, formContext);
        
        TagUtil.getCustomTagConfig().setSecurePort(-1);
        target.setSrc("/R12345");
        target.setSecure(true);
        
        assertThat(target.doStartTag(), is(Tag.SKIP_BODY));
        assertThat(target.doEndTag(), is(Tag.EVAL_PAGE));
        
        actual = TagTestUtil.getOutput(pageContext);
        expected = Builder.lines(
                "<img",
                "src=\"https://nablarch.co.jp" + WebTestUtil.CONTEXT_PATH + "/R12345" + WebTestUtil.ENCODE_URL_SUFFIX + "?nablarch_static_content_version=1.0.0" + '"',
                "alt=\"alt_test\" />").replace(Builder.LS, " ");
        System.out.println(actual);
        TagTestUtil.assertTag(actual, expected, " ");
        
        assertFalse(formContext.getInputNames().contains("name_test"));

        // secureÂ±ûÊÄß„Ååfalse„ÅÆÂ†¥Âêà„ÄÅ„Åã„Å§port„ÅÆÊåáÂÆö„Åå„Å™„ÅÑÂ†¥Âêà

        TagTestUtil.clearOutput(pageContext);
        formContext = TagTestUtil.createFormContext();
        TagUtil.setFormContext(pageContext, formContext);
        
        TagUtil.getCustomTagConfig().setPort(-1);
        target.setSrc("/R12345");
        target.setSecure(false);
        
        assertThat(target.doStartTag(), is(Tag.SKIP_BODY));
        assertThat(target.doEndTag(), is(Tag.EVAL_PAGE));
        
        actual = TagTestUtil.getOutput(pageContext);
        expected = Builder.lines(
                "<img",
                "src=\"http://nablarch.co.jp" + WebTestUtil.CONTEXT_PATH + "/R12345" + WebTestUtil.ENCODE_URL_SUFFIX + "?nablarch_static_content_version=1.0.0" + '"',
                "alt=\"alt_test\" />").replace(Builder.LS, " ");
        System.out.println(actual);
        TagTestUtil.assertTag(actual, expected, " ");
        
        assertFalse(formContext.getInputNames().contains("name_test"));
    }
    
    @Test
    public void testInputPageForDefaultWithAbsolutePath() throws Exception {
        
        FormContext formContext = TagTestUtil.createFormContext();
        TagUtil.setFormContext(pageContext, formContext);
        
        // img
        target.setSrc("/R12345");
        target.setAlt("alt_test");
        
        assertThat(target.doStartTag(), is(Tag.SKIP_BODY));
        assertThat(target.doEndTag(), is(Tag.EVAL_PAGE));
        
        String actual = TagTestUtil.getOutput(pageContext);
        String expected = Builder.lines(
                "<img",
                "src=\"" + WebTestUtil.CONTEXT_PATH + "/R12345" + WebTestUtil.ENCODE_URL_SUFFIX + "?nablarch_static_content_version=1.0.0" + '"',
                "alt=\"alt_test\" />").replace(Builder.LS, " ");
        System.out.println(actual);
        TagTestUtil.assertTag(actual, expected, " ");
        
        assertFalse(formContext.getInputNames().contains("name_test"));
    }    
    
    /**
     * Êú¨„Çø„Ç∞„ÅåForm„Çø„Ç∞ÂÜÖ„Å´ÂÆöÁæ©„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥ÂêàÔºàFormContext„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥ÂêàÔºâ„Å´„ÄÅ
     * IllegalArgumentException„Åå„Çπ„É≠„Éº„Åï„Çå„Å™„ÅÑ„Åì„Å®„ÅÆ„ÉÜ„Çπ„Éà„ÄÇ
     */
    @Test
    public void testNotChildOfForm() throws Exception {

        // generic
        TagTestUtil.setGenericAttributes(target);
        
        // img
        target.setSrc("./R12345");
        target.setAlt("alt_test");
        target.setName("name_test");
        target.setLongdesc("longdesc_test");
        target.setHeight("height_test");
        target.setWidth("width_test");
        target.setUsemap("usemap_test");
        target.setIsmap("ismap_test");
        target.setAlign("align_test");
        target.setBorder("border_test");
        target.setHspace("hspace_test");
        target.setVspace("vspace_test");

        target.doStartTag();

        // ‰æãÂ§ñ„Åå„Çπ„É≠„Éº„Åï„Çå„Å™„Åë„Çå„Å∞ÊàêÂäü
        assertTrue(true);
    }

    /**
     * Ë®ÄË™û„Åî„Å®„ÅÆ„É™„ÇΩ„Éº„ÇπÂàá„ÇäÊõø„ÅàÂà§ÂÆö„Çí„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É´„Éº„Éà„ÅÆ‰ªòÂä†„Çà„ÇäÂÖà„Å´ÂÆüÊñΩ„Åó„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åô„Çã„ÉÜ„Çπ„Éà„ÄÇ
     * ResourcePathRule„Å´Ê∏°„Åï„Çå„Çã„Éë„Çπ„Å´„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàÂêç„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åì„Å®„Çí„Ç¢„Çµ„Éº„Éà„Åô„Çã„ÄÇ
     */
    @Test
    public void testInputPageForResourcePathRule() throws Exception {

        ThreadContext.setLanguage(Locale.JAPANESE);
        TagTestUtil.setUpDefaultConfig();

        FormContext formContext = TagTestUtil.createFormContext();
        TagUtil.setFormContext(pageContext, formContext);

        TagUtil.getCustomTagConfig().setResourcePathRule(new ResourcePathRule() {
            @Override
            public String getPathForLanguage(String path, HttpServletRequest request) {
                assertThat("„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Éë„Çπ„Åå‰ªòÂä†„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åì„Å®„ÄÇ", path, is("/R12345"));
                return path + "_" + ThreadContext.getLanguage();
            }
            @Override
            protected String createPathForLanguage(String pathFromContextRoot, String language) {
                return null;
            }
        });

        // img
        target.setSrc("/R12345");
        target.setAlt("alt_test");

        assertThat(target.doStartTag(), is(Tag.SKIP_BODY));
        assertThat(target.doEndTag(), is(Tag.EVAL_PAGE));

        String actual = TagTestUtil.getOutput(pageContext);
        String expected = Builder.lines(
                "<img",
                "src=\"" + WebTestUtil.CONTEXT_PATH + "/R12345_ja" + WebTestUtil.ENCODE_URL_SUFFIX + "?nablarch_static_content_version=1.0.0" + '"',
                "alt=\"alt_test\" />").replace(Builder.LS, " ");
        System.out.println(actual);
        TagTestUtil.assertTag(actual, expected, " ");

        assertFalse(formContext.getInputNames().contains("name_test"));
    }

    /**
     *  "http"„ÄÅ"https" „Å®„ÅÑ„Å£„Åü„Çπ„Ç≠„Éº„Éû„Çí‰ªòÂä†„Åô„ÇãÂá¶ÁêÜ„ÅåË®ÄË™û„Åî„Å®„ÅÆ„É™„ÇΩ„Éº„ÇπÂàá„ÇäÊõø„Åà„Çà„ÇäÂæå„Å´Ë°å„Çè„Çå„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åô„Çã„ÉÜ„Çπ„Éà„ÄÇ
     */
    @Test
    public void testInputPageForResourcePathRuleForSecure() throws Exception {

        ThreadContext.setLanguage(Locale.JAPANESE);
        TagTestUtil.setUpDefaultConfig();

        FormContext formContext = TagTestUtil.createFormContext();
        TagUtil.setFormContext(pageContext, formContext);

        TagUtil.getCustomTagConfig().setResourcePathRule(new ResourcePathRule() {
            @Override
            public String getPathForLanguage(String path, HttpServletRequest request) {
                return path + "_" + ThreadContext.getLanguage();
            }
            @Override
            protected String createPathForLanguage(String pathFromContextRoot, String language) {
                return null;
            }
        });

        String actual;
        String expected;

        // img
        target.setAlt("alt_test");

        // secureÂ±ûÊÄß„Ååtrue„ÅÆÂ†¥Âêà(„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Éë„Çπ„ÅÆÂÖàÈ†≠„Å´"/"„ÅÇ„Çä)
        target.setSrc("/R12345");
        target.setSecure(true);

        assertThat(target.doStartTag(), is(Tag.SKIP_BODY));
        assertThat(target.doEndTag(), is(Tag.EVAL_PAGE));

        actual = TagTestUtil.getOutput(pageContext);
        expected = Builder.lines(
                "<img",
                "src=\"https://nablarch.co.jp:443" + WebTestUtil.CONTEXT_PATH + "/R12345_ja" + WebTestUtil.ENCODE_URL_SUFFIX + "?nablarch_static_content_version=1.0.0" + '"',
                "alt=\"alt_test\" />").replace(Builder.LS, " ");
        System.out.println(actual);
        TagTestUtil.assertTag(actual, expected, " ");

        assertFalse(formContext.getInputNames().contains("name_test"));

        // secureÂ±ûÊÄß„Ååtrue„ÅÆÂ†¥Âêà(„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Éë„Çπ„ÅÆÂÖàÈ†≠„Å´"/"„Å™„Åó)

        pageContext.getMockReq().setContextPath("dummy");

        TagTestUtil.clearOutput(pageContext);
        formContext = TagTestUtil.createFormContext();
        TagUtil.setFormContext(pageContext, formContext);

        target.setSrc("/R12345");
        target.setSecure(true);

        assertThat(target.doStartTag(), is(Tag.SKIP_BODY));
        assertThat(target.doEndTag(), is(Tag.EVAL_PAGE));

        actual = TagTestUtil.getOutput(pageContext);
        expected = Builder.lines(
                "<img",
                "src=\"https://nablarch.co.jp:443/dummy/R12345_ja" + WebTestUtil.ENCODE_URL_SUFFIX + "?nablarch_static_content_version=1.0.0" + '"',
                "alt=\"alt_test\" />").replace(Builder.LS, " ");
        System.out.println(actual);
        TagTestUtil.assertTag(actual, expected, " ");

        assertFalse(formContext.getInputNames().contains("name_test"));
        
        // secureÂ±ûÊÄß„Ååfalse„ÅÆÂ†¥Âêà

        pageContext.getMockReq().setContextPath(WebTestUtil.CONTEXT_PATH);

        TagTestUtil.clearOutput(pageContext);
        formContext = TagTestUtil.createFormContext();
        TagUtil.setFormContext(pageContext, formContext);
        
        target.setSrc("/R12345");
        target.setSecure(false);
        
        assertThat(target.doStartTag(), is(Tag.SKIP_BODY));
        assertThat(target.doEndTag(), is(Tag.EVAL_PAGE));
        
        actual = TagTestUtil.getOutput(pageContext);
        expected = Builder.lines(
                "<img",
                "src=\"http://nablarch.co.jp:8080" + WebTestUtil.CONTEXT_PATH + "/R12345_ja" + WebTestUtil.ENCODE_URL_SUFFIX + "?nablarch_static_content_version=1.0.0" + '"',
                "alt=\"alt_test\" />").replace(Builder.LS, " ");
        System.out.println(actual);
        TagTestUtil.assertTag(actual, expected, " ");
        
        assertFalse(formContext.getInputNames().contains("name_test"));
        
        // secureÂ±ûÊÄß„Ååtrue„ÅÆÂ†¥Âêà„ÄÅ„Åã„Å§securePort„ÅÆÊåáÂÆö„Åå„Å™„ÅÑÂ†¥Âêà

        TagTestUtil.clearOutput(pageContext);
        formContext = TagTestUtil.createFormContext();
        TagUtil.setFormContext(pageContext, formContext);
        
        TagUtil.getCustomTagConfig().setSecurePort(-1);
        target.setSrc("/R12345");
        target.setSecure(true);
        
        assertThat(target.doStartTag(), is(Tag.SKIP_BODY));
        assertThat(target.doEndTag(), is(Tag.EVAL_PAGE));
        
        actual = TagTestUtil.getOutput(pageContext);
        expected = Builder.lines(
                "<img",
                "src=\"https://nablarch.co.jp" + WebTestUtil.CONTEXT_PATH + "/R12345_ja" + WebTestUtil.ENCODE_URL_SUFFIX + "?nablarch_static_content_version=1.0.0" + '"',
                "alt=\"alt_test\" />").replace(Builder.LS, " ");
        System.out.println(actual);
        TagTestUtil.assertTag(actual, expected, " ");
        
        assertFalse(formContext.getInputNames().contains("name_test"));

        // secureÂ±ûÊÄß„Ååfalse„ÅÆÂ†¥Âêà„ÄÅ„Åã„Å§port„ÅÆÊåáÂÆö„Åå„Å™„ÅÑÂ†¥Âêà

        TagTestUtil.clearOutput(pageContext);
        formContext = TagTestUtil.createFormContext();
        TagUtil.setFormContext(pageContext, formContext);
        
        TagUtil.getCustomTagConfig().setPort(-1);
        target.setSrc("/R12345");
        target.setSecure(false);
        
        assertThat(target.doStartTag(), is(Tag.SKIP_BODY));
        assertThat(target.doEndTag(), is(Tag.EVAL_PAGE));
        
        actual = TagTestUtil.getOutput(pageContext);
        expected = Builder.lines(
                "<img",
                "src=\"http://nablarch.co.jp" + WebTestUtil.CONTEXT_PATH + "/R12345_ja" + WebTestUtil.ENCODE_URL_SUFFIX + "?nablarch_static_content_version=1.0.0" + '"',
                "alt=\"alt_test\" />").replace(Builder.LS, " ");
        System.out.println(actual);
        TagTestUtil.assertTag(actual, expected, " ");
        
        assertFalse(formContext.getInputNames().contains("name_test"));
    }
}
